# Kiro 账号配额管理与自动排除机制

## 概述

本文档说明 AIClient-2-API 如何自动管理 Kiro 账号的配额耗尽情况，确保服务稳定性和自动故障转移。

## 核心机制

### 1. 配额耗尽检测

当 Kiro 账号信用用完时，Claude API 返回 **402 Payment Required** 状态码。系统会自动：

1. **验证配额状态**：调用 `getUsageLimits()` 确认配额是否真的耗尽
2. **立即标记不健康**：将账号标记为 `isHealthy = false`
3. **设置恢复时间**：自动计算下月1日 00:00:00 UTC（Kiro 配额每月重置）
4. **触发账号切换**：立即切换到池中的下一个健康账号

### 2. 自动排除逻辑

**实现位置**：`src/providers/claude/claude-kiro.js:1656-1676`

```javascript
async _handle402Error(error, context = 'unknown') {
    console.log(`[Kiro] Received 402 (Quota Exceeded) in ${context}. Verifying usage limits...`);

    // 验证配额是否真的耗尽
    const usageLimits = await this.getUsageLimits();
    const isQuotaExhausted = usageLimits?.usedCount >= usageLimits?.limitCount;

    console.log(`[Kiro] Quota confirmed exhausted: ${usageLimits?.usedCount}/${usageLimits?.limitCount}`);

    // 计算恢复时间：下月1日 00:00:00 UTC
    const nextMonth = this._getNextMonthFirstDay();
    this._markCredentialUnhealthyWithRecovery('402 Payment Required - Quota Exhausted', error, nextMonth);

    // 标记需要切换账号，但不计入错误次数
    error.shouldSwitchCredential = true;
    error.skipErrorCount = true;
    throw error;
}
```

### 3. Pool Manager 处理

**实现位置**：`src/providers/provider-pool-manager.js:1354-1398`

```javascript
markProviderUnhealthyWithRecovery(providerType, providerConfig, errorMessage, recoveryTime) {
    const provider = this._findProvider(providerType, providerConfig.uuid);
    if (provider) {
        provider.config.isHealthy = false;
        provider.config.errorCount = this.maxErrorCount; // 设置为最大值（默认10）
        provider.config.lastErrorTime = new Date().toISOString();
        provider.config.scheduledRecoveryTime = recoveryDate.toISOString();

        // 持久化到 Redis
        this._persistProviderUpdate(providerType, providerConfig.uuid, {
            isHealthy: false,
            errorCount: this.maxErrorCount,
            lastErrorTime: provider.config.lastErrorTime,
            lastErrorMessage: errorMessage,
            scheduledRecoveryTime: recoveryDateStr
        });
    }
}
```

**关键字段**：
- `isHealthy`: `false` - 账号不健康，调度器会跳过
- `errorCount`: `10` (maxErrorCount) - 标记为确定性失败
- `scheduledRecoveryTime`: 下月1日 ISO 时间戳 - 自动恢复时间点

### 4. 调度器行为

当选择账号时，调度器会：

1. **过滤不健康账号**：只选择 `isHealthy = true` 的账号
2. **轮询健康账号**：使用 round-robin 算法在健康账号间分配请求
3. **自动切换**：遇到 402 错误时立即切换到下一个账号

**实现位置**：`src/providers/provider-pool-manager.js` 的 `selectProvider()` 方法

### 5. 自动恢复机制

**实现位置**：`src/providers/provider-pool-manager.js:1696-1702`

定期健康检查（默认每10分钟）会检测恢复时间：

```javascript
// 检查是否有预定的恢复时间
if (config.scheduledRecoveryTime) {
    const recoveryTime = new Date(config.scheduledRecoveryTime);
    const now = new Date();

    if (now >= recoveryTime) {
        // 恢复健康状态
        config.isHealthy = true;
        config.errorCount = 0;
        config.lastErrorTime = null;
        config.lastErrorMessage = null;
        config.scheduledRecoveryTime = null; // 清除恢复时间

        console.log(`[ProviderPool] Provider ${config.uuid} recovered at scheduled time`);
    }
}
```

**恢复条件**：
- 当前时间 >= `scheduledRecoveryTime`
- 自动重置所有错误状态
- 账号重新加入健康池

## 配置参数

### Pool Manager 配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `maxErrorCount` | 10 | 错误次数阈值，达到后标记为不健康 |
| `healthCheckInterval` | 600000 (10分钟) | 健康检查间隔（毫秒） |

### 错误处理策略

| 错误类型 | HTTP 状态码 | 处理方式 | 是否计入错误次数 |
|----------|-------------|----------|------------------|
| 配额耗尽 | 402 | 立即标记不健康 + 设置恢复时间 | ❌ 否（`skipErrorCount = true`） |
| 认证失败 | 401/403 | 立即标记不健康 | ✅ 是（设置为 maxErrorCount） |
| 临时错误 | 429/500/503 | 累积错误计数 | ✅ 是（每次 +1） |

## 工作流程示例

### 场景：3个 Kiro 账号，其中1个配额耗尽

```
初始状态：
├─ Account A: isHealthy=true, errorCount=0
├─ Account B: isHealthy=true, errorCount=0
└─ Account C: isHealthy=true, errorCount=0

请求1 → Account A (成功)
请求2 → Account B (成功)
请求3 → Account C (返回 402)
  ├─ 验证配额：usedCount=1000000, limitCount=1000000 ✓
  ├─ 标记不健康：isHealthy=false
  ├─ 设置恢复时间：2026-02-01T00:00:00.000Z
  └─ 切换到 Account A

当前状态：
├─ Account A: isHealthy=true, errorCount=0  ← 可用
├─ Account B: isHealthy=true, errorCount=0  ← 可用
└─ Account C: isHealthy=false, scheduledRecoveryTime=2026-02-01 ← 已排除

请求4 → Account A (成功)
请求5 → Account B (成功)
请求6 → Account A (成功) ← 只在 A/B 间轮询

2026-02-01 00:00:00 UTC 后：
└─ 健康检查自动恢复 Account C
   ├─ isHealthy=true
   ├─ errorCount=0
   └─ scheduledRecoveryTime=null

恢复后状态：
├─ Account A: isHealthy=true ← 可用
├─ Account B: isHealthy=true ← 可用
└─ Account C: isHealthy=true ← 已恢复，重新加入轮询
```

## 监控与调试

### 查看账号状态

通过 Web UI 或 API 查看账号池状态：

```bash
# 获取 provider 统计信息
GET /api/providers/stats?type=claude-kiro-oauth

# 响应示例
{
  "total": 3,
  "healthy": 2,
  "unhealthy": 1,
  "disabled": 0
}
```

### 日志关键字

搜索以下日志关键字来追踪配额管理：

```bash
# 配额耗尽检测
[Kiro] Received 402 (Quota Exceeded)
[Kiro] Quota confirmed exhausted: 1000000/1000000

# 账号标记为不健康
Marked provider as unhealthy with recovery time

# 自动恢复
Provider {uuid} recovered at scheduled time

# 健康检查
Health check for {uuid} (claude-kiro-oauth): Marked Healthy
```

### Redis 数据结构

账号状态存储在 Redis 中：

```bash
# 查看账号配置
redis-cli GET "aiclient:provider-pools:claude-kiro-oauth:{uuid}"

# 示例数据
{
  "uuid": "abc-123",
  "isHealthy": false,
  "errorCount": 10,
  "lastErrorTime": "2026-01-29T10:30:00.000Z",
  "lastErrorMessage": "402 Payment Required - Quota Exhausted",
  "scheduledRecoveryTime": "2026-02-01T00:00:00.000Z",
  "usageCount": 1523,
  "lastUsed": "2026-01-29T10:30:00.000Z"
}
```

## 最佳实践

### 1. 配置多个账号

建议配置至少 **3个 Kiro 账号**，确保：
- 单个账号配额耗尽时，其他账号可继续服务
- 避免服务中断
- 提高总体配额上限

### 2. 监控配额使用

定期检查账号配额使用情况：
- 通过 Web UI 查看 "使用统计" 页面
- 设置告警：当健康账号数 < 2 时通知管理员

### 3. 错误窗口期配置

默认错误窗口期为 **5分钟**（`errorWindowMs = 5 * 60 * 1000`）：
- 5分钟内的错误会累积
- 超过5分钟后，错误计数重置
- 避免偶发错误导致账号被误标记

### 4. 手动干预

如需手动禁用/启用账号：

```bash
# 通过 Web UI
访问 "Provider 管理" → 找到对应账号 → 点击 "禁用/启用"

# 通过 API
POST /api/providers/disable
{
  "providerType": "claude-kiro-oauth",
  "uuid": "abc-123"
}

POST /api/providers/enable
{
  "providerType": "claude-kiro-oauth",
  "uuid": "abc-123"
}
```

## 故障排查

### 问题：所有账号都被标记为不健康

**可能原因**：
1. 所有账号配额都已耗尽
2. 网络问题导致健康检查失败
3. Redis 连接中断

**解决方案**：
```bash
# 1. 检查 Redis 连接
GET /api/redis/status

# 2. 查看账号状态
GET /api/providers/stats?type=claude-kiro-oauth

# 3. 手动重置账号（如果确认配额未耗尽）
POST /api/providers/reset-counters
{
  "providerType": "claude-kiro-oauth",
  "uuid": "abc-123"
}

# 4. 检查日志
docker logs aiclient-api | grep -i "402\|quota\|unhealthy"
```

### 问题：账号未在下月1日自动恢复

**可能原因**：
1. 健康检查未运行（进程重启）
2. `scheduledRecoveryTime` 未正确设置
3. 时区问题

**解决方案**：
```bash
# 1. 检查 scheduledRecoveryTime
redis-cli GET "aiclient:provider-pools:claude-kiro-oauth:{uuid}"

# 2. 手动触发健康检查
# 重启服务会立即执行一次健康检查
docker restart aiclient-api

# 3. 手动标记为健康
POST /api/providers/mark-healthy
{
  "providerType": "claude-kiro-oauth",
  "uuid": "abc-123"
}
```

## 相关文件

| 文件路径 | 说明 |
|---------|------|
| `src/providers/claude/claude-kiro.js` | Kiro provider 实现，包含 402 错误处理 |
| `src/providers/provider-pool-manager.js` | 账号池管理器，负责健康检查和调度 |
| `src/core/redis-config-manager.js` | Redis 存储适配器，持久化账号状态 |
| `src/ui-modules/provider-api.js` | Provider 管理 API 端点 |
| `CLAUDE.md` | 项目架构文档 |

## 更新日志

- **2026-01-29**: 创建文档，说明 Kiro 配额管理与自动排除机制
